---
title: "Automatic Detection"
author: "Howard Baek"
date: "6/29/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Libraries
```{r}
library(tidyverse)
library(lubridate)
library(scales)
library(factoextra)
library(raster)
library(tmap)
library(png)
library(gridExtra)
library(dendextend)
library(DescTools)
library(imageryML)
library(plotly)
library(ggmap)
library(rerddap)
library(patchwork)

theme_set(theme_light())
```

<!-- everything below is sandboxing -->

<!--

## Notes from paper

Upwelling is defined by a certain temperature drop compared to the surrounding water temperature close to the coast. Such strong upwelling events could contribute to replenishing the euphotic zone with the nutritional components necessary for biological productivity.

Automatic Detection Method: A simple temperature threshold value was specified. Upwelling was detected by calculating the temperature difference for each individual pixel from the zonal mean temperature, for every pixel line. 

Two different temperature thresholds: 2 degrees / 3.5 degrees.

## Function to import data from ERDDAP

```{r}
import_erddap <- function(start_date, stop_date, min_lat, max_lat, min_lon, max_lon) {
  
  url <- paste0("https://coastwatch.pfeg.noaa.gov/erddap/griddap/ncdcOisst21Agg.csv?sst%5B(",
                start_date, "T12:00:00Z):(", stop_date, "T12:00:00Z)%5D%5B(0.0)%5D%5B(", 
                min_lat, "):(", max_lat, ")%5D%5B(",
                min_lon, "):(", max_lon, ")%5D&.draw=surface&.vars=longitude%7Clatitude%7Csst&.colorBar=%7C%7C%7C12%7C19%7C&.bgColor=0xffccccff")
  
  print("Reading data from url.........")
  
  df <- read_csv(url)
  
  print(".........DONE!!!")
  
  file_name <- paste0("data/erddap_", start_date, "_", stop_date,
                      "_", "lat_", min_lat, "_", max_lat,
                      "_lon_", min_lon, "_", max_lon, ".csv")
  
  # Write to csv
  df %>% 
    write_csv(file_name)
  
  # User message
  msg <- paste0("Data saved to working directory as ", file_name)
  print(msg)
}
```



## Data Preprocessing: Daily data

Latitude (42.625, 52.125) and Longitude (229.875, 236.625) 

### Degree Conversion:

Longitude: 230 degree East - 360 = -130 degree West

```{r}
# I downloaded the data using read_csv("https://coastwatch.pfeg.noaa.gov/erddap/griddap/ncdcOisst21Agg.csv?sst%5B(2010-01-01T12:00:00Z):(2021-06-01T12:00:00Z)%5D%5B(0.0)%5D%5B(42.625):(52.125)%5D%5B(229.875):(236.625)%5D&.draw=surface&.vars=longitude%7Clatitude%7Csst&.colorBar=%7C%7C%7C12%7C19%7C&.bgColor=0xffccccff")
# This big data is saved as pilot_data.csv

# Raw data (last 10 years)
df_raw <- read_csv("data/pilot_data.csv")

# Processed data
df_processed <- df_raw %>% 
  # Get rid of miscellaneous zlev in first row
  slice(-1) %>% 
  # zlev is a column of zeroes, so get rid of that
  dplyr::select(-zlev) %>% 
  # Convert into date
  mutate(time = ymd_hms(time)) %>% 
  # Set column names
  rename(date = time,
         lat = latitude,
         lon = longitude) %>% 
  # Convert date column to Date type
  mutate(date = as.Date(date),
         lat = as.numeric(lat),
         lon = as.numeric(lon),
         sst = as.numeric(sst))

# mask out Puget Sound, Strait of Juan de Fuca and Georgia Strait
masks <- list(c(235.4488, 236.884, 47.87651, 50.13138),
              c(232.2913, 233.8987, 50.28689, 51.60871),
              c(234.4154, 235.9654, 49.04283, 50.09251))

for (m1 in masks) {
  # index of Puget Sound, Strait of Juan de Fuca or Georgia Strait
  mask_loc <- df_processed$lat <= m1[4] & df_processed$lat >= m1[3] &
    df_processed$lon <= m1[2] & df_processed$lon >= m1[1]
  # Change to NA
  df_processed$sst[mask_loc] <- NA
}
```


## Raw data Plot
```{r}
df_processed %>% 
  filter(date == "2010-01-01") %>% 
  sample_n(20) %>% 
  ggplot() +
  geom_point(aes(lon, lat)) +
  geom_point(aes(lon, lat), data = df_processed %>% 
               filter(date == "2010-01-01",
                      is.nan(sst) |
                        is.na(sst)),
             color = "red") +
  geom_text(aes(lon, lat,label = sst),
            data = df_processed %>% 
              filter(date == "2010-01-01") %>% 
              sample_n(500),
            vjust = 0.5, hjust = 1) +
  geom_vline(xintercept = 236.625, color = "midnightblue") +
  geom_hline(yintercept = 52.125, color = "midnightblue") 
```


## Stamen map with SST
```{r}
# Create sample data (2010-01-01)
sample_df <- df_processed %>% 
  filter(date == "2010-01-01") %>% 
  mutate(lon = lon - 360)

# Give coordinates for map
bbox <- c(left = 229.875 - 360, bottom = 42.625, right = 236.625 - 360, top = 52.125)
# Get stamen map
ocean_map <- get_stamenmap(bbox, zoom = 8)

# Plot
ggmap(ocean_map) +
  geom_tile(aes(lon, lat, fill = sst),
            alpha = 0.4,
            data = sample_df) +
  geom_rect(xmin = -125, xmax = -124.2,
            ymin = 43, ymax = 44.4,
            fill = NA,
            color = "red",
            size = 1) +
  scale_fill_gradient2(midpoint = mean(sample_df$sst, na.rm = TRUE),
                       low = "blue",
                       mid = "white",
                       high = "red") +
  labs(x = NULL,
       y = NULL,
       fill = "Sea Surface Temperature (SST)",
       title = "Latitude (42.625, 52.125) and Longitude (229.875, 236.625)")
```


## Algorithm to detect SST at coast (border between ocean and land)

- 28 longitude values for each latitude
- 2 degree threshold

```{r}
# Create sample data (2010-01-01)
sample_df <- df_processed %>% 
  filter(date == "2010-01-01") %>% 
  mutate(lon = lon - 360)


# Find which latitude has the most NA or NaN SST values
sample_df %>% 
  group_by(lat) %>% 
  filter(is.na(sst) | is.nan(sst)) %>% 
  count(lat, sort = TRUE)

# Find 4 SST values next to land (sst_coast_X)
is_upwelling <- sample_df %>% 
  group_by(lat) %>% 
  # 1 longitude tick away from land
  mutate(sst_coast_1 = last(na.omit(sst)),
         # 8 longitude ticks away from land (2 degrees in longitude)
         sst_coast_2 = nth(na.omit(sst), -9),
         # 12 longitude ticks away from land (3 degrees in longitude)
         sst_coast_3 = nth(na.omit(sst), -13)) %>% 
  # Find difference between pixels
  # Threshold: 0.15
  summarize(is_upwelling_1_2 = sst_coast_2 - sst_coast_1 > 0.15,
            is_upwelling_1_3 = sst_coast_3 - sst_coast_1 > 0.15) %>% 
  ungroup() %>% 
  group_by(lat) %>% 
  # Check if any upwelling in each latitude
  # first() because I want to return one row for each lat
  summarise(is_upwelling_total = first(is_upwelling_1_2 | is_upwelling_1_3)) %>% 
  ungroup()

# upwelling latitudes
# is_upwelling %>% 
#   View()
```

## How to find Differentials: 

Find difference between one next to coast and everything else 

People are doing 1 or 2 degree off-shore. Having them only 0.25 degree apart is too close. You are seeing how wide these cold water plumes. You are getting wide / close plumes.

DO NOT USE ABSOLUTE VALUE for temperature difference. Just want colder water on the coast. 

- Latitude & Longitude: every 0.25 degrees


## Function to detect upwelling and plot on stamen map

- Join `sample_data` and `is_upwelling` to get `is_upweling_total` column into sample_data
- Find (coast) longitude corresponding to row preceding last Na/NaN value in SST

```{r}
final_df <- sample_df %>% 
  left_join(is_upwelling) %>%
  ungroup() %>% 
  group_by(lat) %>% 
  # Find  (coast) longitude corresponding to row preceding last Na/NaN value in SST
  mutate(last_lon = across(sst, ~ tail(lon[!is.na(.)], 1))) %>% 
  ungroup() %>% 
  mutate(last_lon = last_lon$sst)

# 
# # Create df for rectangle coordinates
# rect_coord <- final_df %>% 
#   filter(is_upwelling_total) %>% 
#   select(lat, last_lon) %>% 
#   unique() %>% 
#   mutate(xmin = last_lon - 0.4,
#          xmax = last_lon + 0.01,
#          ymin = lat - 0.4,
#          ymax = lat + 0.4) 
```

## Upwelling Map

```{r}
# Plot
ggplot() +
  geom_tile(aes(lon, lat, fill = sst),
            alpha = 0.9,
            data = final_df) +
  geom_point(data = final_df %>% filter(is_upwelling_total),
             mapping = aes(x = last_lon, y = lat),
             size = 1.5,
             shape = 8,
             color = "red") +
  scale_x_continuous(labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df$sst, na.rm = TRUE),
                       low = "blue",
                       mid = "white",
                       high = "red",
                       na.value = "azure4") +
  coord_quickmap() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        panel.border = element_blank(),
        legend.position = "bottom",
        legend.background=element_blank()) +
  labs(x = NULL,
       y = NULL,
       fill = "Sea Surface Temperature (SST)",
       title = "Latitude (42.625, 52.125) and Longitude (229.875, 236.625)")
```


## coord_quickmap()

In general, map projections must account for the fact that the actual length (in km) of one degree of longitude varies between the equator and the pole. Near the equator, the ratio between the lengths of one degree of latitude and one degree of longitude is approximately 1. Near the pole, it tends towards infinity because the length of one degree of longitude tends towards 0. For regions that span only a few degrees and are not too close to the poles, setting the aspect ratio of the plot to the appropriate lat/lon ratio approximates the usual mercator projection. This is what coord_quickmap() does, and is much faster (particularly for complex plots like geom_tile()) at the expense of correctness.




## Function to plot rectangles around upwelling
```{r}
auto_detect <- function(df_raw, 
                        custom_date, 
                        lon_min = 229.875, lon_max = 236.625,
                        lat_min = 42.625, lat_max = 52.125,
                        threshold) {
  
  # Process data
  df_processed <- df_raw %>% 
    # Get rid of miscellaneous zlev in first row
    slice(-1) %>% 
    # zlev is a column of zeroes, so get rid of that
    dplyr::select(-zlev) %>% 
    # Convert into date
    mutate(time = ymd_hms(time)) %>% 
    # Set column names
    rename(date = time,
           lat = latitude,
           lon = longitude) %>% 
    # Convert date column to Date type
    mutate(date = as.Date(date),
           lat = as.numeric(lat),
           lon = as.numeric(lon),
           sst = as.numeric(sst))
  
  # mask out Puget Sound, Strait of Juan de Fuca and Georgia Strait
  masks <- list(c(235.4488, 236.884, 47.87651, 50.13138),
                c(232.2913, 233.8987, 50.28689, 51.60871),
                c(234.4154, 235.9654, 49.04283, 50.09251))
  
  for (m1 in masks) {
    # index of Puget Sound, Strait of Juan de Fuca or Georgia Strait
    mask_loc <- df_processed$lat <= m1[4] & df_processed$lat >= m1[3] &
      df_processed$lon <= m1[2] & df_processed$lon >= m1[1]
    # Change to NA
    df_processed$sst[mask_loc] <- NA
  }
  # Create df for specific date
  df_processed_date <- df_processed %>% 
    filter(date == custom_date) %>% 
    mutate(lon = lon - 360)
  
  
  # Stamen Map
  # Give coordinates for map
  bbox <- c(left = lon_min - 360, bottom = lat_min, right = lon_max - 360, top = lat_max)
  # Get stamen map
  ocean_map <- get_stamenmap(bbox, zoom = 8)
  
  
  # Automatic Detection Method
  # Find SST values next to land (sst_coast_X) and check if upwelling
  is_upwelling <- df_processed_date %>% 
    group_by(lat) %>% 
    # 1 longitude tick away from land
    mutate(sst_coast_1 = last(na.omit(sst)),
           # 4 longitude ticks away from land (1 degree in longitude)
           sst_coast_2 = nth(na.omit(sst), -5),
           # 8 longitude ticks away from land (2 degrees in longitude)
           sst_coast_3 = nth(na.omit(sst), -9),
           # 12 longitude ticks away from land (3 degrees in longitude)
           sst_coast_4 = nth(na.omit(sst), -13)) %>% 
    # Find difference between pixels
    # Threshold: 0.15
    summarize(is_upwelling_1_2 = sst_coast_2 - sst_coast_1 > threshold,
              is_upwelling_1_3 = sst_coast_3 - sst_coast_1 > threshold,
              is_upwelling_1_4 = sst_coast_4 - sst_coast_1 > threshold) %>% 
    ungroup() %>% 
    group_by(lat) %>% 
    # Check if any upwelling in each latitude
    # first() because I want to return one row for each lat
    summarise(is_upwelling_total = first(is_upwelling_1_2 | is_upwelling_1_3 | is_upwelling_1_4)) %>% 
    ungroup()
  
  
  
  
  final_df <- df_processed_date %>% 
    left_join(is_upwelling) %>%
    ungroup() %>% 
    group_by(lat) %>% 
    # Find  (coast) longitude corresponding to row preceding last Na/NaN value in SST
    mutate(last_lon = across(sst, ~ tail(lon[!is.na(.)], 1))) %>% 
    ungroup() %>% 
    mutate(last_lon = last_lon$sst)
  
  
  # Create df for rectangle coordinates
  rect_coord <- final_df %>% 
    filter(is_upwelling_total) %>% 
    select(lat, last_lon) %>% 
    unique() %>% 
    mutate(xmin = last_lon - 0.4,
           xmax = last_lon + 0.01,
           ymin = lat - 0.4,
           ymax = lat + 0.4) 
  
  
  # Plot
  ggplot() +
    geom_tile(aes(lon, lat, fill = sst),
              alpha = 0.4,
              data = final_df) +
    geom_rect(data = rect_coord,
              mapping = aes(xmin = xmin, xmax = xmax,
                            ymin = ymin, ymax = ymax),
              size = 1,
              fill = NA,
              color = "red") +
    scale_fill_gradient2(midpoint = mean(final_df$sst, na.rm = TRUE),
                         low = "blue",
                         mid = "white",
                         high = "red") +
    labs(x = NULL,
         y = NULL,
         fill = "Sea Surface Temperature (SST)",
         title = paste0("Date: ", custom_date,
                        " Threshold: ", threshold, "degrees"),
         subtitle = paste0("Latitude (",
                           lat_min,
                           ",",
                           lat_max,
                           ") ",
                           " Longitude (",
                           lon_min,
                           ",",
                           lon_max,
                           ")")
    )
}
```


## Workflow
```{r}
df_raw <- import_erddap(start_date = "2020-01-01", stop_date = "2021-06-01",
                        min_lat = 34.125, max_lat = 52.625, min_lon = 225.625,
                        max_lon = 244.125)

auto_detect(df_raw, custom_date = "2021-06-01", threshold = 2)
```


## Eli Feedback

Maybe use a red dot instead of big red square to denote the upwelling.

```{r}
# Plot
ggplot() +
  geom_tile(data = final_df,
            mapping = aes(lon, lat, fill = sst),
            alpha = 0.4) +
  # Use red dot (x = last_lon, y = lat)
  geom_point(data = final_df %>% filter(is_upwelling_total),
             mapping = aes(x = last_lon, y = lat),
             size = 1.5,
             shape = 8,
             color = "red") +
  scale_fill_gradient2(midpoint = mean(final_df$sst, na.rm = TRUE),
                       low = "blue",
                       mid = "white",
                       high = "red",
                       na.value = "grey10") +
  labs(x = NULL,
       y = NULL,
       fill = "Sea Surface Temperature (SST)",
       title = paste0("Date: ", "2010-01-01",
                      " Threshold: ", 0.15, " degrees")
  )
```


## Updated Automatic Detection Function

```{r}
auto_detect <- function(df_raw, 
                        custom_date, 
                        min_lon, max_lon,
                        min_lat, max_lat,
                        threshold) {
  
  # Process data
  df_processed <- df_raw %>% 
    # Get rid of miscellaneous zlev in first row
    slice(-1) %>% 
    # zlev is a column of zeroes, so get rid of that
    dplyr::select(-zlev) %>% 
    # Convert into date
    mutate(time = ymd_hms(time)) %>% 
    # Set column names
    rename(date = time,
           lat = latitude,
           lon = longitude) %>% 
    # Convert date column to Date type
    mutate(date = as.Date(date),
           lat = as.numeric(lat),
           lon = as.numeric(lon),
           sst = as.numeric(sst))
  
  # mask out Puget Sound, Strait of Juan de Fuca and Georgia Strait
  masks <- list(c(235.4488, 236.884, 47.87651, 50.13138),
                c(232.2913, 233.8987, 50.28689, 51.60871),
                c(234.4154, 235.9654, 49.04283, 50.09251))
  
  for (m1 in masks) {
    # index of Puget Sound, Strait of Juan de Fuca or Georgia Strait
    mask_loc <- df_processed$lat <= m1[4] & df_processed$lat >= m1[3] &
      df_processed$lon <= m1[2] & df_processed$lon >= m1[1]
    # Change to NA
    df_processed$sst[mask_loc] <- NA
  }
  # Create df for specific date
  df_processed_date <- df_processed %>% 
    filter(date == custom_date) %>% 
    mutate(lon = lon - 360)
  
  # Automatic Detection Method
  # Find SST values next to land (sst_coast_X) and check if upwelling
  is_upwelling <- df_processed_date %>% 
    group_by(lat) %>% 
    # 1 longitude tick away from land
    mutate(sst_coast_1 = last(na.omit(sst)),
           # 8 longitude ticks away from land (2 degrees in longitude)
           sst_coast_2 = nth(na.omit(sst), -9),
           # 12 longitude ticks away from land (3 degrees in longitude)
           sst_coast_3 = nth(na.omit(sst), -13)) %>% 
    # Find difference between pixels
    # Threshold: 0.15
    summarize(is_upwelling_1_2 = sst_coast_2 - sst_coast_1 > threshold,
              is_upwelling_1_3 = sst_coast_3 - sst_coast_1 > threshold) %>% 
    ungroup() %>% 
    group_by(lat) %>% 
    # Check if any upwelling in each latitude
    # first() because I want to return one row for each lat
    summarise(is_upwelling_total = first(is_upwelling_1_2 | is_upwelling_1_3)) %>% 
    ungroup()
  
  
  final_df <- df_processed_date %>% 
    left_join(is_upwelling) %>%
    ungroup() %>% 
    group_by(lat) %>% 
    # Find  (coast) longitude corresponding to row preceding last Na/NaN value in SST
    mutate(last_lon = across(sst, ~ tail(lon[!is.na(.)], 1))) %>% 
    ungroup() %>% 
    # last_lon: longitude off coast
    mutate(last_lon = last_lon$sst,
           # For blue dots
           last_lon_minus_two = last_lon - 2,
           last_lon_minus_three = last_lon - 3)
  
  # final_df for upwelling
  final_df_upwelling <- final_df %>% 
    filter(is_upwelling_total)
  
  # Plot
  ggplot() +
    geom_tile(aes(lon, lat, fill = sst),
              alpha = 0.9,
              data = final_df) +
    geom_point(data = final_df_upwelling,
               mapping = aes(x = last_lon, y = lat),
               size = 1.5,
               shape = 8,
               color = "red") +
    geom_point(data = final_df_upwelling,
               mapping = aes(x = last_lon_minus_two, y = lat),
               size = 1.5,
               shape = 8,
               color = "blue") +
    geom_point(data = final_df_upwelling,
               mapping = aes(x = last_lon_minus_three, y = lat),
               size = 1.5,
               shape = 8,
               color = "blue") +
    scale_x_continuous(labels = label_number(suffix ="\u00b0")) +
    scale_y_continuous(labels = label_number(suffix ="\u00b0")) +
    scale_fill_gradient2(midpoint = mean(final_df$sst, na.rm = TRUE),
                         low = "blue",
                         mid = "white",
                         high = "red",
                         na.value = "grey20") +
    coord_quickmap() +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          legend.position = "bottom",
          legend.background=element_blank()) +
    labs(x = NULL,
         y = NULL,
         fill = "Sea Surface Temperature (\u00B0C)",
         title = paste0("Date: ", custom_date,
                        " Threshold: ", threshold, " \u00B0C"),
         subtitle = paste0("Latitude (",
                           min_lat,
                           "\u00B0,",
                           max_lat,
                           "\u00B0) ",
                           " Longitude (",
                           min_lon - 360,
                           "\u00B0,",
                           max_lon - 360,
                           "\u00B0)",
                           "\n\nRed dots are location of upwelling \nBlue dots are location of comparison to red dots")
    )
  
  # Use below to save plots
  # file_name <- paste0(custom_date, "-autodetect.png")
  # ggsave(file_name)
  
}
```



## Updated Workflow

```{r}
# Read erddap and writes as csv
import_erddap(start_date = "2000-01-01", stop_date = "2021-06-01",
              min_lat = 40.625, max_lat = 50.625, min_lon = 229.875,
              max_lon = 236.625)

# SST 
df_raw <- read_csv("data/erddap_2000-01-01_2021-06-01_lat_40.625_50.625_lon_229.875_236.625.csv")

auto_detect(df_raw, custom_date = "2000-10-01", threshold = 2.5,
            min_lat = 40.625, max_lat = 50.625, min_lon = 229.875,
            max_lon = 236.625)
```



## Past 5 Years: Proportion of Upwelling

```{r}
# Read erddap and write as csv
# import_erddap(start_date = "2015-01-01", stop_date = "2020-12-31",
#               min_lat = 40.625, max_lat = 50.625, min_lon = 229.875,
#               max_lon = 236.625)

# Data from past 5 years
df_raw <- read_csv("data/erddap_2015-01-01_2020-12-31_lat_40.625_50.625_lon_229.875_236.625.csv")


# Process data
df_processed <- df_raw %>% 
  # Get rid of miscellaneous zlev in first row
  slice(-1) %>% 
  # zlev is a column of zeroes, so get rid of that
  dplyr::select(-zlev) %>% 
  # Convert into date
  mutate(time = ymd_hms(time)) %>% 
  # Set column names
  rename(date = time,
         lat = latitude,
         lon = longitude) %>% 
  # Convert date column to Date type
  mutate(date = as.Date(date),
         lat = as.numeric(lat),
         lon = as.numeric(lon),
         sst = as.numeric(sst))

# mask out Puget Sound, Strait of Juan de Fuca and Georgia Strait
masks <- list(c(235.4488, 236.884, 47.87651, 50.13138),
              c(232.2913, 233.8987, 50.28689, 51.60871),
              c(234.4154, 235.9654, 49.04283, 50.09251))

for (m1 in masks) {
  # index of Puget Sound, Strait of Juan de Fuca or Georgia Strait
  mask_loc <- df_processed$lat <= m1[4] & df_processed$lat >= m1[3] &
    df_processed$lon <= m1[2] & df_processed$lon >= m1[1]
  # Change to NA
  df_processed$sst[mask_loc] <- NA
}


# Create df for specific date
df_processed_date <- df_processed %>% 
  mutate(lon = lon - 360)

# Automatic Detection Method
# Find SST values next to land (sst_coast_X) and check if upwelling
is_upwelling <- df_processed_date %>% 
  group_by(date, lat) %>% 
  # 1 longitude tick away from land
  mutate(sst_coast_1 = last(na.omit(sst)),
         # 8 longitude ticks away from land (2 degrees in longitude)
         sst_coast_2 = nth(na.omit(sst), -9),
         # 12 longitude ticks away from land (3 degrees in longitude)
         sst_coast_3 = nth(na.omit(sst), -13)) %>% 
  ungroup() %>% 
  group_by(date, lat) %>% 
  # Find difference between pixels
  # Threshold: 0.15
  summarize(is_upwelling_1_2 = sst_coast_2 - sst_coast_1 > 2.5,
            is_upwelling_1_3 = sst_coast_3 - sst_coast_1 > 2.5) %>% 
  ungroup() %>% 
  group_by(date, lat) %>% 
  # Check if any upwelling in each latitude
  # first() because I want to return one row for each lat
  summarise(is_upwelling_total = first(is_upwelling_1_2 | is_upwelling_1_3)) %>% 
  ungroup()

# Look at proportion of upwelling
is_upwelling %>% 
  group_by(date) %>% 
  summarise(upwelling_prop = mean(is_upwelling_total, na.rm = TRUE)) %>% 
  filter(upwelling_prop > 0) %>% 
  arrange(desc(upwelling_prop))


final_df <- df_processed_date %>% 
  left_join(is_upwelling, by = c("date", "lat")) %>%
  ungroup() %>% 
  # last_lon: longitude off coast
  mutate(year = year(date),
         month = month(date),
         day = day(date))


# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_month <- function(tbl) {
  
  tbl %>%
    group_by(month, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling_total), .groups = "drop")
}


# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_day <- function(tbl) {
  
  tbl %>%
    group_by(day, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling_total), .groups = "drop")
  
}


# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_year <- function(tbl) {
  
  tbl %>%
    group_by(year, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling_total), .groups = "drop")
  
}
```


Plot
```{r}
final_df_processed <- final_df %>%
  summarise_by_month()

final_df_land <- final_df %>%
  filter(is.na(sst))

# Plot
ggplot() +
  # Upwelling proportion
  geom_tile(aes(lon, lat, fill = upwelling_prop),
            data = final_df_processed) +
  # Add land
  geom_tile(aes(lon, lat, fill = sst),
            data = final_df_land) +
  scale_x_continuous(labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_processed$upwelling_prop, na.rm = TRUE),
                       low = "blue",
                       mid = "white",
                       high = "red",
                       na.value = "grey20",
                       labels = percent,
                       breaks = c(0, 0.3, 0.5)) +
  facet_wrap(~year) +
  coord_quickmap() +
  labs(y = "",
       fill = "Upwelling Percentage") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        panel.border = element_blank(),
        legend.position = "bottom",
        legend.background=element_blank()) 
```

-->

<!-- everything above is sandboxing -->

## Past 40 Years: Proportion of Upwelling

```{r}
df_raw <- read_csv("data/erddap_1982-01-01_2021-06-29_lat_40.625_50.625_lon_229.875_236.625.csv")

# Process data
df_processed <- df_raw %>% 
  # Get rid of miscellaneous zlev in first row
  slice(-1) %>% 
  # zlev is a column of zeroes, so get rid of that
  dplyr::select(-zlev) %>% 
  # Convert into date
  mutate(time = lubridate::ymd_hms(time)) %>% 
  # Set column names
  rename(date = time,
         lat = latitude,
         lon = longitude) %>% 
  # Convert date column to Date type
  mutate(date = as.Date(date),
         lat = as.numeric(lat),
         lon = as.numeric(lon),
         sst = as.numeric(sst))

# mask out Puget Sound, Strait of Juan de Fuca and Georgia Strait
masks <- list(c(235.4488, 236.884, 47.87651, 50.13138),
              c(232.2913, 233.8987, 50.28689, 51.60871),
              c(234.4154, 235.9654, 49.04283, 50.09251))

for (m1 in masks) {
  # index of Puget Sound, Strait of Juan de Fuca or Georgia Strait
  mask_loc <- df_processed$lat <= m1[4] & df_processed$lat >= m1[3] &
    df_processed$lon <= m1[2] & df_processed$lon >= m1[1]
  # Change to NA
  df_processed$sst[mask_loc] <- NA
}


df_processed_date <- df_processed %>% 
  mutate(lon = lon - 360)

# Automatic Detection Method
# Find SST values next to land (sst_coast_X) and check if upwelling
is_upwelling <- df_processed_date %>% 
  group_by(date, lat) %>% 
  # 1 longitude tick away from land
  mutate(sst_coast_1 = last(na.omit(sst)),
         # 8 longitude ticks away from land (2 degrees in longitude)
         sst_coast_2 = nth(na.omit(sst), -9),
         # 12 longitude ticks away from land (3 degrees in longitude)
         sst_coast_3 = nth(na.omit(sst), -13)) %>% 
  ungroup() %>% 
  group_by(date, lat) %>% 
  # Find difference between pixels
  # Threshold: 2.5
  summarize(is_upwelling_1_2 = sst_coast_2 - sst_coast_1 > 2,
            is_upwelling_1_3 = sst_coast_3 - sst_coast_1 > 2) %>% 
  ungroup() %>% 
  group_by(date, lat) %>% 
  # Check if any upwelling in each latitude
  # first() because I want to return one row for each lat
  summarise(is_upwelling_total = first(is_upwelling_1_2 | is_upwelling_1_3)) %>% 
  ungroup()


final_df <- df_processed_date %>% 
  left_join(is_upwelling, by = c("date", "lat")) %>%
  ungroup() %>% 
  # last_lon: longitude off coast
  mutate(year = year(date),
         month = month(date),
         day = day(date)) %>% 
  # Filter out 2021
  filter(year < 2021)


# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_month <- function(tbl) {
  
  tbl %>%
    group_by(month, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling_total), .groups = "drop")
}


# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_year <- function(tbl) {
  
  tbl %>%
    group_by(year, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling_total), .groups = "drop")
  
}

# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_decade <- function(tbl) {
  
  tbl %>%
    mutate(decade = (year %/% 10) * 10) %>% 
    group_by(decade, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling_total), .groups = "drop")
  
}
```



```{r}
final_df_processed <- final_df %>%
  summarise_by_year()

final_df_land <- final_df %>%
  filter(is.na(sst))


# By Month
final_df_processed <- final_df %>%
  summarise_by_month()

final_df_processed_heatmap <- final_df_processed %>% 
  distinct(month, lat, upwelling_prop) %>% 
  filter(lat < 50)

# ggplot() +
#   # Upwelling proportion
#   geom_tile(aes(lon, lat, fill = upwelling_prop),
#             data = final_df_processed) +
#   # Add land
#   geom_tile(aes(lon, lat, fill = sst),
#             data = final_df_land) +
#   scale_x_continuous(labels = label_number(suffix ="\u00b0")) +
#   scale_y_continuous(labels = label_number(suffix ="\u00b0")) +
#   scale_fill_gradient2(midpoint = mean(final_df_processed$upwelling_prop, na.rm = TRUE),
#                        low = "blue",
#                        mid = "white",
#                        high = "red",
#                        na.value = "grey20",
#                        labels = percent,
#                        breaks = c(0, 0.25, 0.5, 0.9)) +
#   facet_wrap(~month) +
#   coord_quickmap() +
#   labs(y = "",
#        fill = "Upwelling Percentage",
#        title = "Upwelling Percentage by Latitude: 1982 ~ 2021") +
#   theme(axis.title.x=element_blank(),
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank(),
#         panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom",
#         legend.background=element_blank()) 
# 

# Heatmap
final_df_processed_heatmap %>%
  ggplot(aes(month, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = "Months",
                     breaks = c(1:12),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_processed_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  theme(legend.position = "bottom") +
  ggtitle("Upwelling Percentage by Latitude for each Month",
          subtitle = "1982 ~ 2020")
```




## Line Plot and Heatmap of Proportion of Upwelling by Latitude Facetted by Year and Decade

```{r}
# By Year
final_df_year <- final_df %>%
  summarise_by_year()

# Plot
final_df_year %>%
  ggplot(aes(lat, upwelling_prop)) +
  geom_line(color = "midnightblue", 
            size = 1.1,
            show.legend = FALSE) +
  geom_vline(xintercept = 42.5, lty = 2) +
  geom_vline(xintercept = 48.4, lty = 2) +
  facet_wrap(~year) +
  scale_x_continuous(breaks = c(42.5, 45, 48.4, 50),
                     labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = percent) +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  labs(x = NULL,
       y = "Upwelling Percentage",
       title = "Upwelling Percentage by Latitude: 1982-2020",
       subtitle = "Dotted lines at Upwelling Hot Spots")


# By Year Heatmap
final_df_year_heatmap <- final_df_year %>% 
  distinct(year, lat, upwelling_prop) %>% 
  # Filter out 50 degree latitude because NA
  filter(lat < 50)

# Plot all months
final_df_year_heatmap %>% 
  ggplot(aes(year, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(seq(from = 1982, to = 2020, by = 5), 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_year_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  ggtitle("Upwelling Percentage by Latitude for each Year",
          subtitle = "1982 ~ 2020")


# Plot only upwelling months
final_df %>%
  filter(month %in% 6:10) %>% 
  summarise_by_year() %>%
  distinct(year, lat, upwelling_prop) %>% 
  # Filter out 50 degree latitude because NA
  filter(lat < 50) %>% 
  ggplot(aes(year, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(seq(from = 1982, to = 2020, by = 5), 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_year_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  ggtitle("Upwelling Percentage by Latitude for each Year",
          subtitle = "1982 ~ 2020 Upwelling Months (June to Oct)")




# By Decade
final_df_decade <- final_df %>%
  summarise_by_decade()

# Lineplot
final_df_decade %>%
  # Filter out 2020 because not enough data
  filter(decade < 2020) %>% 
  mutate(decade = as.character(decade),
         decade = case_when(
           decade == "1980" ~ "1980s",
           decade == "1990" ~ "1990s",
           decade == "2000" ~ "2000s",
           decade == "2010" ~ "2010s",
           TRUE ~ decade
         )) %>% 
  ggplot(aes(lat, upwelling_prop)) +
  geom_line(color = "midnightblue", 
            size = 1.2,
            show.legend = FALSE) +
  geom_vline(xintercept = 42.5, lty = 2) +
  geom_vline(xintercept = 48.4, lty = 2) +
  facet_wrap(~decade) +
  scale_x_continuous(breaks = c(42.5, 45, 48.4, 50),
                     labels = scales::label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = scales::percent) +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  labs(x = NULL,
       y = "Upwelling Percentage",
       title = "Upwelling Percentage by Latitude Facetted by Decade",
       subtitle = "Dotted lines at Upwelling Hot Spots")

# By Decade Heatmap
final_df_decade_heatmap <- final_df_decade %>% 
  distinct(decade, lat, upwelling_prop) %>% 
  # Filter out 2020 because not enough data
  # Filter out 50 degree latitude because NA
  filter(decade < 2020,
         lat < 50)

# Plot
final_df_decade_heatmap %>% 
  ggplot(aes(decade, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(1980, 1990, 2000, 2010),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_decade_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  theme(legend.position = "bottom") +
  ggtitle("Upwelling Percentage by Latitude for each Decade",
          subtitle = "1982 ~ 2020")
```


## Line Plot of Proportion of Upwelling by Latitude Facetted by Month

```{r}
# By Month
final_df_month <- final_df %>%
  summarise_by_month()


final_df_month %>% 
  filter(upwelling_prop > 0.05) %>% 
  mutate(month = factor(month.abb[month], levels = month.abb),
         month = fct_reorder(month, -upwelling_prop)) %>% 
  ggplot(aes(lat, upwelling_prop)) +
  geom_line(aes(color = month, group = month)) +
  geom_vline(xintercept = 42.5, lty = 2) +
  geom_vline(xintercept = 48.4, lty = 2) +
  scale_x_continuous(labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = percent) +
  expand_limits(y = 0) +
  labs(x = NULL,
       y = "Upwelling Percentage",
       title = "Upwelling Percentage by Latitude: 1982-2021",
       subtitle = "Dotted lines at Hot Spots",
       color = NULL)

final_df_month %>% 
  mutate(month = factor(month.abb[month],levels=month.abb)) %>% 
  ggplot(aes(lat, upwelling_prop)) +
  geom_line(aes(color = month), 
            size = 1.2,
            show.legend = FALSE) +
  geom_vline(xintercept = 42.5, lty = 2) +
  geom_vline(xintercept = 48.4, lty = 2) +
  facet_wrap(~month) +
  scale_x_continuous(breaks = c(42.5, 45, 48.4, 50),
                     labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = percent) +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = -30, vjust = 1, hjust = 0)) +
  labs(x = NULL,
       y = "Upwelling Percentage",
       title = "Upwelling Percentage by Latitude: 1982-2021",
       subtitle = "Dotted lines at Upwelling Hot Spots")
```


## Get percentage of Upwelling in each month

Want to get % of days in monthX that are upwelling. Each line is from monthX with different lines representing different years (2000-2021)

```{r}
# Data
prop_days_upwelling <- final_df %>% 
  # Get distinct values of is_upwelling_total for each day
  distinct(year, month, day, lat, is_upwelling_total) %>% 
  group_by(year, month) %>% 
  summarise(upwelling_prop = mean(is_upwelling_total, na.rm = TRUE), .groups = "drop")

# Plot 1
prop_days_upwelling %>% 
  filter(year > 1981, year < 2000) %>% 
  mutate(year = factor(year)) %>% 
  ggplot(aes(month, upwelling_prop)) +
  geom_point(color = "midnightblue") +
  geom_line(aes(color = year, group = year), show.legend = FALSE) +
  facet_wrap(~year) +
  scale_x_continuous(breaks = c(1, 3, 6, 9, 12), labels = month.abb[c(1, 3, 6, 9, 12)]) +
  scale_y_continuous(name = "Upwelling Percentage", labels = percent) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  labs(x = NULL,
       title = "Proportion of Upwelling in each Month Facetted by Year",
       subtitle = "1982 ~ 1999")


# Plot 2
prop_days_upwelling %>% 
  filter(year > 1999, year < 2021) %>% 
  mutate(year = factor(year)) %>% 
  ggplot(aes(month, upwelling_prop)) +
  geom_point(color = "midnightblue") +
  geom_line(aes(color = year, group = year), show.legend = FALSE) +
  facet_wrap(~year) +
  scale_x_continuous(breaks = c(1, 3, 6, 9, 12), labels = month.abb[c(1, 3, 6, 9, 12)]) +
  scale_y_continuous(name = "Upwelling Percentage", labels = percent) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  labs(x = NULL,
       title = "Proportion of Upwelling in each Month Facetted by Year",
       subtitle = "2000 ~ 2020")



# Heatmap of all the latitudes
prop_days_upwelling %>% 
  ggplot(aes(year, month, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(1982, 1990, 2000, 2010, 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     breaks = 1:12,
                     labels = month.abb) +
  scale_fill_gradient2(midpoint = mean(prop_days_upwelling$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  ggtitle("Upwelling Percentage by Month for each Year",
          subtitle = "1982 ~ 2020")



# Heatmap of binned latitudes
final_df %>% 
  # Get distinct values of is_upwelling_total for each day
  distinct(year, month, day, lat, is_upwelling_total) %>% 
  filter(lat < 50) %>% 
  mutate(lat_binned = cut(lat, breaks = c(40, 43.5, 46.125, 47.625, 50),
                          labels = c("[40\u00b0, 43.5\u00b0]",
                                     "[43.5\u00b0, 46.125\u00b0]",
                                     "[46.125\u00b0, 47.625\u00b0]",
                                     "[47.625\u00b0, 50\u00b0]"))) %>%
  group_by(year, month, lat_binned) %>% 
  summarise(upwelling_prop = mean(is_upwelling_total, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(year, month, fill = upwelling_prop)) +
  geom_tile() +
  facet_wrap(~lat_binned) +
  scale_x_continuous(name = NULL,
                     breaks = c(1982, 1990, 2000, 2010, 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     breaks = 1:12,
                     labels = month.abb) +
  scale_fill_gradient2(midpoint = mean(prop_days_upwelling$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 0),
        legend.position = "bottom") +
  ggtitle("Upwelling Percentage by Month for each Year Facetted by Latitude Bins",
          subtitle = "1982 ~ 2020")

```


## Patch Heatmaps together for blogpost

```{r}
p3 <- final_df_processed_heatmap %>%
  ggplot(aes(month, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(1:12),
                     labels = month.abb,
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_processed_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent,
                       breaks = c(0, 0.5, 0.95)) +
  theme(legend.position = "bottom") +
  ggtitle("Upwelling % by Latitude for each Month",
          subtitle = "1982 ~ 2020")


p1 <- final_df_decade_heatmap %>%
  ggplot(aes(decade, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(1980, 1990, 2000, 2010),
                     labels = c("1980s", "1990s", "2000s", "2010s"),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(name = "Upwelling Percentage",
                       midpoint = mean(final_df_decade_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       labels = percent,
                       breaks = c(0.15, 0.35, 0.5)
  ) +
  theme(legend.position = "bottom") +
  ggtitle("Upwelling % by Latitude for each Decade",
          subtitle = "1982 ~ 2020")



p2 <- prop_days_upwelling %>% 
  ggplot(aes(year, month, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(1982, 1985, 1990, 1995,
                                2000, 2005, 2010, 2015,
                                2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     breaks = 1:12,
                     labels = month.abb) +
  scale_fill_gradient2(name = "Upwelling Percentage",
                       midpoint = mean(prop_days_upwelling$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       labels = percent,
                       breaks = c(0, 0.5, 0.95)) +
  theme(legend.position = "bottom") +
  ggtitle("Upwelling % by Month for each Year",
          subtitle = "1982 ~ 2020")



p4 <- final_df %>% 
  # Get distinct values of is_upwelling_total for each day
  distinct(year, month, day, lat, is_upwelling_total) %>% 
  filter(lat < 50) %>% 
  mutate(lat_binned = cut(lat, breaks = c(40, 43.5, 46.125, 47.625, 50),
                          labels = c("[40\u00b0, 43.5\u00b0]",
                                     "[43.5\u00b0, 46.125\u00b0]",
                                     "[46.125\u00b0, 47.625\u00b0]",
                                     "[47.625\u00b0, 50\u00b0]"))) %>%
  group_by(year, month, lat_binned) %>% 
  summarise(upwelling_prop = mean(is_upwelling_total, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(year, month, fill = upwelling_prop)) +
  geom_tile() +
  facet_wrap(~lat_binned) +
  scale_x_continuous(name = NULL,
                     breaks = c(1982, 1985, 1990, 1995,
                                2000, 2005, 2010, 2015,
                                2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     breaks = c(1,3, 6, 9, 12),
                     labels = month.abb[c(1,3, 6, 9, 12)]) +
  scale_fill_gradient2(midpoint = mean(prop_days_upwelling$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent,
                       breaks = c(0, 0.5, 1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 0),
        legend.position = "bottom") +
  ggtitle("Upwelling % Facetted by Latitude Bins",
          subtitle = "1982 ~ 2020")


# Patchwork time
(p1 | p2) /
  (p3 | p4)
```



## Compare Automatic Detection to Upwelling Index

```{r}
# Read in upwelling index data
upw_index <- read_csv("data/erdUI426hr_c91c_fb11_7659.csv") %>% 
  select(-station_id) %>% 
  # Get rid of miscellaneous first row
  slice(-1) %>% 
  # Convert date column to Date type
  transmute(date = as.Date(time),
            upwelling_index,
            lat = as.numeric(latitude),
            lon = as.numeric(longitude))

# Change 6hour into daily avgs
upw_index_daily <- upw_index %>% 
  group_by(date, lon, lat) %>% 
  # Average 6 hour upwelling index to get daily index
  summarise(upwelling_index_daily_avg = mean(upwelling_index), .groups = "drop")

# Check upwelling index at 2020-10-01
upw_index_daily %>% 
  filter(date == "2020-09-01")
```


## Get Upwelling Index Data

Search dataset
```{r}
ui_search <- ed_search(query = "upwelling index", which = "tabledap",
                       url = "https://coastwatch.pfeg.noaa.gov/erddap/")
ui_search$info
```


Upwelling Index, 45N 125W, 6-hourly                erdUI456hr
Upwelling Index, 48N 125W, 6-hourly                erdUI486hr
Upwelling Index, 42N 125W, 6-hourly                erdUI426hr
Upwelling Index, 39N 125W, 6-hourly                erdUI396hr



Call datatset
```{r}
first_df <- tabledap("erdUI456hr") %>% 
  as_tibble() %>%  
  dplyr::select(-station_id) %>%
  # Convert date column to Date type
  transmute(date = as.Date(time),
            upwelling_index,
            lat = as.numeric(latitude),
            lon = as.numeric(longitude)) %>% 
  group_by(date, lon, lat) %>% 
  # Average 6 hour upwelling index to get daily index
  summarise(upwelling_index_daily_avg = mean(upwelling_index), .groups = "drop")


second_df <- tabledap("erdUI486hr") %>% 
  as_tibble() %>%  
  dplyr::select(-station_id) %>% 
  # Convert date column to Date type
  transmute(date = as.Date(time),
            upwelling_index,
            lat = as.numeric(latitude),
            lon = as.numeric(longitude)) %>% 
  group_by(date, lon, lat) %>% 
  # Average 6 hour upwelling index to get daily index
  summarise(upwelling_index_daily_avg = mean(upwelling_index), .groups = "drop")


ui_df <- first_df %>% 
  rbind(second_df) %>% 
  mutate(upwelling_index_daily_avg = round(upwelling_index_daily_avg, 0))
```


## Line plots of Monthly upwelling index
```{r}
ui <- tabledap("erdUI456hr") %>% 
  as_tibble() %>%  
  dplyr::select(-station_id) %>%
  # Convert date column to Date type
  transmute(date = as.Date(time),
            upwelling_index,
            lat = as.numeric(latitude),
            lon = as.numeric(longitude)) %>% 
  filter(date >= "1980-01-01")

ui %>% 
  mutate(year = year(date),
         month = month(date),
         day = day(date)) %>% 
  group_by(year, month, lon, lat) %>% 
  summarise(monthly_upwelling_index = mean(upwelling_index, na.rm = TRUE), .groups = "drop") %>% 
  # Make monthly_date as month-01 so its easiesr to plot
  mutate(monthly_date = make_date(year, month, 1)) %>% 
  ggplot(aes(monthly_date, monthly_upwelling_index)) +
  geom_line(color = "midnightblue") +
  geom_smooth(color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = NULL,
       y = "Monthly Upwelling Index",
       title = "Monthly Averages of Upwelling Index \nFrom 1980-01-01 to 2021-05-31")
```


Draw two lines: June, July, Aug, Sept, Oct / rest
```{r}
ui %>% 
  mutate(year = year(date),
         month = month(date),
         day = day(date)) %>%
  group_by(year, month, lon, lat) %>% 
  summarise(monthly_upwelling_index = mean(upwelling_index, na.rm = TRUE), .groups = "drop") %>% 
  mutate(monthly_date = make_date(year, month, 1)) %>%
  mutate(is_upwelling_season = if_else(month %in% c(6, 7, 8, 9, 10), 
                                       "Upwelling Months (6, 7, 8, 9, 10)",
                                       "Non-Upwelling Months (1, 2, 3, 4, 5, 11, 12)")) %>%
  ggplot(aes(monthly_date, monthly_upwelling_index)) +
  geom_line(aes(color = is_upwelling_season), show.legend = FALSE) +
  geom_smooth(color = "gold") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~is_upwelling_season) +
  labs(x = NULL,
       y = "Monthly Upwelling Index",
       title = "Monthly Averages of Upwelling Index \nFrom 1980-01-01 to 2021-05-31")

```


## Boxplot with Upwelling (Y/N) on x-axis and upwelling index on y-axis.

```{r}
ui %>% 
  mutate(year = year(date),
         month = month(date),
         day = day(date)) %>%
  group_by(year, month, lon, lat) %>% 
  summarise(monthly_upwelling_index = mean(upwelling_index, na.rm = TRUE), .groups = "drop") %>% 
  mutate(monthly_date = make_date(year, month, 1)) %>%
  mutate(is_upwelling_season = if_else(month %in% c(6, 7, 8, 9, 10), 
                                       "Upwelling Months (6, 7, 8, 9, 10)",
                                       "Non-Upwelling Months (1, 2, 3, 4, 5, 11, 12)")) %>% 
  ggplot(aes(is_upwelling_season, monthly_upwelling_index)) +
  geom_boxplot() +
  labs(x = NULL,
       y = "Monthly Upwelling Index",
       title = "Monthly Averages of Upwelling Index by Upwelling Months \nFrom 1980-01-01 to 2021-05-31")
```




## AD Plot annotated with UI

```{r}
# Plot
ggplot() +
  geom_tile(aes(lon, lat, fill = sst),
            alpha = 0.9,
            data = final_df) +
  geom_point(data = final_df %>% filter(is_upwelling_total),
             mapping = aes(x = last_lon, y = lat),
             size = 1.5,
             shape = 8,
             color = "red") +
  geom_label(data = ui_df, aes(x = lon, y = lat, label = upwelling_index_daily_avg)) +
  scale_x_continuous(labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df$sst, na.rm = TRUE),
                       low = "blue",
                       mid = "white",
                       high = "red",
                       na.value = "grey20") +
  coord_quickmap() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        panel.border = element_blank(),
        legend.position = "bottom",
        legend.background=element_blank()) +
  labs(x = NULL,
       y = NULL,
       fill = "Sea Surface Temperature (SST)",
       title = "Latitude (42.625, 52.125) and Longitude (229.875, 236.625)",
       subtitle = "Annotated with Average Upwelling Index on 2010-01-01")
```



## Heatmaps of First/Last day of upwelling (automatic detection)

`final_df` is dataset with date, is_upwelling_total, year, month, day columns

```{r}
# Dataset with first month-day of upwelling (detexted by automatic detection)
# and last month-day of upwelling (detected by automatic detection)
final_df_upwelling_day <- final_df %>% 
  filter(is_upwelling_total) %>% 
  distinct(year, month, day, lat) %>%
  # filter for upwelling months: June to Oct
  filter(month %in% c(6:10)) %>% 
  group_by(year, lat) %>% 
  summarize(first_month = first(month),
            first_day = first(day),
            last_month = last(month),
            last_day = last(day), 
            .groups = "drop") %>% 
  mutate(first_month_day = paste0(year, "-0", first_month, "-", first_day),
         first_day_of_year = yday(first_month_day),
         last_month_day = paste0(year, "-", last_month, "-", last_day),
         last_day_of_year = yday(last_month_day))

final_df_upwelling_day
```


#### First Day
```{r}
final_df_upwelling_day %>% 
  ggplot(aes(year, lat)) +
  geom_tile(aes(fill = first_day_of_year)) +
  scale_x_continuous(name = NULL,
                     breaks = c(seq(from = 1982, to = 2020, by = 5), 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, 
                     expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradientn(colours = rev(rainbow(3)),
                       name = "First day of upwelling",
                       breaks = c(180, 210, 240),
                       labels = c("July 1st", "Aug 1st", "Sept 1st")) +
  ggtitle("First Day of Upwelling by Latitude: 1982 ~ 2020",
          subtitle = "Filtered for June~Oct (Upwelling Months)")
```



### Last Day
```{r}
final_df_upwelling_day %>% 
  ggplot(aes(year, lat)) +
  geom_tile(aes(fill = last_day_of_year)) +
  scale_x_continuous(name = NULL,
                     breaks = c(seq(from = 1982, to = 2020, by = 5), 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, 
                     expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0N")) +
  scale_fill_gradientn(colours=rainbow(4))
scale_fill_gradient2(midpoint = mean(final_df_upwelling_day$last_day_of_year, na.rm = TRUE),
                     low = "grey",
                     mid = "white",
                     high = "brown",
                     na.value = "white",
                     name = "Last day of upwelling") +
  ggtitle("Last Day of Upwelling by Latitude: 1982 ~ 2020",
          subtitle = "Filtered for June~Oct (Upwelling Months)")
```



### Line Plot of Mean First and Last Day Across all latitudes
```{r}
final_df_upwelling_day %>% 
  group_by(year) %>% 
  summarise(avg_first_day_of_year = mean(first_day_of_year),
            avg_last_day_of_year = mean(last_day_of_year)) %>% 
  ggplot(aes(year, avg_first_day_of_year)) +
  geom_line(color = "midnightblue", size = 1.2)


final_df_upwelling_day %>% 
  group_by(year) %>% 
  summarise(avg_first_day_of_year = mean(first_day_of_year),
            avg_last_day_of_year = mean(last_day_of_year)) %>% 
  pivot_longer(cols = -year,
               names_to = "day_type",
               values_to = "avg_day") %>% 
  mutate(day_type = fct_reorder(day_type, -avg_day),
         day_type = ifelse(day_type == "avg_first_day_of_year", "First Day of Upwelling", "Last Day of Upwelling")) %>% 
  ggplot(aes(year, avg_day, color = day_type)) +
  geom_line(size = 1.2) +
  scale_x_continuous(breaks = c(1982, 1985, 1990, 1995, 2000,
                                2005, 2010, 2015, 2020)) +
  expand_limits(y = 100) +
  labs(x = NULL,
       y = "Average Day",
       color = NULL,
       title = "Average of First, Last Day of Upwelling across all Latitudes",
       subtitle = "1982-2020") +
  theme(legend.position = c(0.88, 0.1))

```




## Automatic Detection Function: Zonal Mean

```{r}
# Raw data
df_raw <- read_csv("data/erddap_1982-01-01_2021-06-29_lat_40.625_50.625_lon_229.875_236.625.csv")

# Process data
df_processed <- df_raw %>% 
  # Get rid of miscellaneous zlev in first row
  slice(-1) %>% 
  # zlev is a column of zeroes, so get rid of that
  dplyr::select(-zlev) %>% 
  # Convert into date
  mutate(time = ymd_hms(time)) %>% 
  # Set column names
  rename(date = time,
         lat = latitude,
         lon = longitude) %>% 
  # Convert date column to Date type
  mutate(date = as.Date(date),
         lat = as.numeric(lat),
         lon = as.numeric(lon),
         sst = as.numeric(sst))


# mask out Puget Sound, Strait of Juan de Fuca and Georgia Strait
masks <- list(c(235.4488, 236.884, 47.87651, 50.13138),
              c(232.2913, 233.8987, 50.28689, 51.60871),
              c(234.4154, 235.9654, 49.04283, 50.09251))

for (m1 in masks) {
  # index of Puget Sound, Strait of Juan de Fuca or Georgia Strait
  mask_loc <- df_processed$lat <= m1[4] & df_processed$lat >= m1[3] &
    df_processed$lon <= m1[2] & df_processed$lon >= m1[1]
  # Change to NA
  df_processed$sst[mask_loc] <- NA
}


# Create df for specific date
df_processed_date <- df_processed %>%
  mutate(lon = lon - 360)

# Automatic Detection Method
# Find SST values next to land (sst_coast_X) and check if upwelling
is_upwelling <- df_processed_date %>% 
  group_by(date, lat) %>% 
  # 1 longitude tick away from land
  mutate(sst_coast = last(na.omit(sst)),
         # 8 longitude ticks away from land (2 degrees in longitude)
         sst_sea_1 = nth(na.omit(sst), -9),
         # In between longitudes
         sst_sea_2 = nth(na.omit(sst), -10),
         sst_sea_3 = nth(na.omit(sst), -11),
         sst_sea_4 = nth(na.omit(sst), -12),
         # 12 longitude ticks away from land (3 degrees in longitude)
         sst_sea_5 = nth(na.omit(sst), -13)) %>% 
  ungroup() %>% 
  group_by(date, lat, sst_coast) %>% 
  summarize(sst_zonal_mean = (sst_sea_1 + sst_sea_2 + sst_sea_3 + 
                                sst_sea_4 + sst_sea_5) / 5) %>%  
  ungroup() %>% 
  distinct(date, lat, sst_coast, sst_zonal_mean) %>%
  mutate(is_upwelling =  sst_zonal_mean - sst_coast > 2)

# Join
final_df <- df_processed_date %>% 
  left_join(is_upwelling, by = c("date", "lat")) %>%
  ungroup() %>% 
  mutate(year = year(date),
         month = month(date),
         day = day(date)) %>% 
  # Filter out 2021
  filter(year < 2021) %>% 
  # Rearrange columns
  select(date, year, month, day, everything())

# final_df for upwelling
final_df_upwelling <- final_df %>% 
  filter(is_upwelling)


# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_month <- function(tbl) {
  
  tbl %>%
    group_by(month, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling), .groups = "drop")
}


# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_year <- function(tbl) {
  
  tbl %>%
    group_by(year, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling), .groups = "drop")
  
}

# Don't need to na.rm = TRUE because you want to preserve the land
summarise_by_decade <- function(tbl) {
  
  tbl %>%
    mutate(decade = (year %/% 10) * 10) %>% 
    group_by(decade, lat, lon) %>% 
    summarise(upwelling_prop = mean(is_upwelling), .groups = "drop")
  
}
```



### Lineplot / Heatmaps

```{r}
# By Year
final_df_year <- final_df %>%
  summarise_by_year()

# Plot
final_df_year %>%
  ggplot(aes(lat, upwelling_prop)) +
  geom_line(color = "midnightblue", 
            size = 1.1,
            show.legend = FALSE) +
  geom_vline(xintercept = 42.5, lty = 2) +
  geom_vline(xintercept = 48.4, lty = 2) +
  facet_wrap(~year) +
  scale_x_continuous(breaks = c(42.5, 45, 48.4, 50),
                     labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = percent) +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  labs(x = NULL,
       y = "Upwelling Percentage",
       title = "Upwelling Percentage by Latitude: 1982-2020",
       subtitle = "Dotted lines at Upwelling Hot Spots")


# By Year Heatmap
final_df_year_heatmap <- final_df_year %>% 
  distinct(year, lat, upwelling_prop) %>% 
  # Filter out 50 degree latitude because NA
  filter(lat < 50)

# Plot all months
final_df_year_heatmap %>% 
  ggplot(aes(year, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(seq(from = 1982, to = 2020, by = 5), 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_year_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  ggtitle("Upwelling Percentage by Latitude for each Year",
          subtitle = "1982 ~ 2020")


# Plot only upwelling months
final_df %>%
  filter(month %in% 6:10) %>% 
  summarise_by_year() %>%
  distinct(year, lat, upwelling_prop) %>% 
  # Filter out 50 degree latitude because NA
  filter(lat < 50) %>% 
  ggplot(aes(year, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(seq(from = 1982, to = 2020, by = 5), 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_year_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  ggtitle("Upwelling Percentage by Latitude for each Year",
          subtitle = "1982 ~ 2020 Upwelling Months (June to Oct)")




# By Decade
final_df_decade <- final_df %>%
  summarise_by_decade()

# Lineplot
final_df_decade %>%
  # Filter out 2020 because not enough data
  filter(decade < 2020) %>% 
  mutate(decade = as.character(decade),
         decade = case_when(
           decade == "1980" ~ "1980s",
           decade == "1990" ~ "1990s",
           decade == "2000" ~ "2000s",
           decade == "2010" ~ "2010s",
           TRUE ~ decade
         )) %>% 
  ggplot(aes(lat, upwelling_prop)) +
  geom_line(color = "midnightblue", 
            size = 1.2,
            show.legend = FALSE) +
  geom_vline(xintercept = 42.5, lty = 2) +
  geom_vline(xintercept = 48.4, lty = 2) +
  facet_wrap(~decade) +
  scale_x_continuous(breaks = c(42.5, 45, 48.4, 50),
                     labels = scales::label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = scales::percent) +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  labs(x = NULL,
       y = "Upwelling Percentage",
       title = "Upwelling Percentage by Latitude Facetted by Decade",
       subtitle = "Dotted lines at Upwelling Hot Spots")

# By Decade Heatmap
final_df_decade_heatmap <- final_df_decade %>% 
  distinct(decade, lat, upwelling_prop) %>% 
  # Filter out 2020 because not enough data
  # Filter out 50 degree latitude because NA
  filter(decade < 2020,
         lat < 50)

# Plot
final_df_decade_heatmap %>% 
  ggplot(aes(decade, lat, fill = upwelling_prop)) +
  geom_tile() +
  scale_x_continuous(name = NULL,
                     breaks = c(1980, 1990, 2000, 2010),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradient2(midpoint = mean(final_df_decade_heatmap$upwelling_prop, na.rm = TRUE),
                       low = "grey",
                       mid = "white",
                       high = "brown",
                       na.value = "white",
                       name = "Upwelling Percentage",
                       labels = percent) +
  theme(legend.position = "bottom") +
  ggtitle("Upwelling Percentage by Latitude for each Decade",
          subtitle = "1982 ~ 2020")



# By Month
final_df_month <- final_df %>%
  summarise_by_month()



final_df_month %>% 
  mutate(month = factor(month.abb[month],levels=month.abb)) %>% 
  ggplot(aes(lat, upwelling_prop)) +
  geom_line(aes(color = month), 
            size = 1.2,
            show.legend = FALSE) +
  geom_vline(xintercept = 42.5, lty = 2) +
  geom_vline(xintercept = 48.4, lty = 2) +
  facet_wrap(~month) +
  scale_x_continuous(breaks = c(42.5, 45, 48.4, 50),
                     labels = label_number(suffix ="\u00b0")) +
  scale_y_continuous(labels = percent) +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = -30, vjust = 1, hjust = 0)) +
  labs(x = NULL,
       y = "Upwelling Percentage",
       title = "Upwelling Percentage by Latitude: 1982-2021",
       subtitle = "Dotted lines at Upwelling Hot Spots")




# Dataset with first month-day of upwelling (detected by automatic detection)
# and last month-day of upwelling (detected by automatic detection)
final_df_upwelling_day <- final_df %>% 
  filter(is_upwelling) %>% 
  distinct(year, month, day, lat) %>%
  # filter for upwelling months: June to Oct
  filter(month %in% c(6:10)) %>% 
  group_by(year, lat) %>% 
  summarize(first_month = first(month),
            first_day = first(day),
            last_month = last(month),
            last_day = last(day), 
            .groups = "drop") %>% 
  mutate(first_month_day = paste0(year, "-0", first_month, "-", first_day),
         first_day_of_year = yday(first_month_day),
         last_month_day = paste0(year, "-", last_month, "-", last_day),
         last_day_of_year = yday(last_month_day))

final_df_upwelling_day %>% 
  ggplot(aes(year, lat)) +
  geom_tile(aes(fill = first_day_of_year)) +
  scale_x_continuous(name = NULL,
                     breaks = c(seq(from = 1982, to = 2020, by = 5), 2020),
                     expand = c(0, 0)) + 
  scale_y_continuous(name = NULL, 
                     expand = c(0, 0),
                     labels = label_number(suffix ="\u00b0")) +
  scale_fill_gradientn(colours = rev(rainbow(3)),
                       name = "First day of upwelling",
                       breaks = c(180, 210, 240),
                       labels = c("July 1st", "Aug 1st", "Sept 1st")) +
  ggtitle("First Day of Upwelling by Latitude: 1982 ~ 2020",
          subtitle = "Filtered for June~Oct (Upwelling Months)")
```

